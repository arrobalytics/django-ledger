{% load i18n %}
{% load django_ledger %}


<form method="post">

    {{ staged_txs_formset.non_form_errors }}
    {#    {% if staged_txs_formset.errors %}#}
    {#        {{ staged_txs_formset.errors }}#}
    {#    {% endif %}#}
    {{ staged_txs_formset.management_form }}

    {% csrf_token %}

    <div class="table-container">
        <table class="table is-narrow is-fullwidth is-bordered is-striped django-ledger-table-bottom-margin-75">
            <thead>
            <tr class="has-text-centered is-error">
                <th></th>
                <th>Dated Posted</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Split Amount</th>
                <th>Map To</th>
                <th>Unit</th>
                <th>Receipt Type</th>
                <th>Customer/Vendor</th>
                <th>Import</th>
                <th>Bundle</th>
                <th>Split</th>
                <th>Delete</th>
            </tr>
            </thead>

            <tbody>

            {% for txf in staged_txs_formset %}
                <tr id="staged-tx-{{ txf.instance.uuid }}" class="{% if txf.instance.is_children %}has-background-primary{% elif txf.instance.has_children %}has-background-primary-light{% endif %}">
                    <td>{{ forloop.counter }}</td>
                    {% for hidden_field in txf.hidden_fields %}{{ hidden_field }}{% endfor %}
                    {% if txf.instance.is_children %}
                        <td class="has-background-primary-light" style="border: 0px"></td>
                        <td class="has-background-primary-light" style="border: 0px"></td>
                        <td class="has-background-primary-light" style="border: 0px"></td>
                        <td>{{ txf.amount_split }}</td>
                    {% else %}
                        <td>{{ txf.instance.date_posted }}</td>
                        <td>{{ txf.instance.name }}</td>
                        <td class="has-text-right has-text-weight-bold">
                            {% currency_symbol %}{{ txf.instance.amount | currency_format }}</td>
                        <td class="has-text-right">{{ txf.amount_split }}
                            {% if txf.instance.has_children %}
                                {% currency_symbol %}{{ txf.instance.total_amount_split | currency_format }}
                            {% endif %} </td>
                    {% endif %}

                    <td>
                        {% if txf.instance.get_prospect_je_activity_display %}
                            <span class="has-text-success">{% icon 'lets-icons:check-fill' 16 %}</span>
                            <span class="is-italic">{% trans 'Transaction Activity' %}:</span>
                            <span class="has-text-weight-bold">
                             {{ txf.instance.get_prospect_je_activity_display }}
                        </span>
                        {% elif not txf.instance.is_children %}
                            <span class="has-text-danger">{% icon 'ooui:block' 16 %}</span>
                            <span>Invalid or Pending Account Mapping.</span>
                        {% endif %}
                        {{ txf.account_model }}
                        {% if txf.errors %}
                            {% for i,err in txf.errors.items %}
                                <span class="has-text-danger">{{ err }}</span>
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td>{{ txf.unit_model }}</td>
                    <td>{{ txf.receipt_type }}</td>
                    <td class="has-text-centered">
                        {% if txf.SHOW_CUSTOMER_FIELD %}
                            {{ txf.customer_model }}
                        {% elif txf.SHOW_VENDOR_FIELD %}
                            {{ txf.vendor_model }}
                        {% endif %}
                    </td>
                    <td class="has-text-centered">{{ txf.tx_import }}</td>
                    <td class="has-text-centered">{{ txf.bundle_split }}</td>
                    <td class="has-text-centered">{{ txf.tx_split }}</td>
                    <td class="has-text-centered">{{ txf.DELETE }}</td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>

    <div class="columns is-centered">
        <div class="column is-4 has-text-centered">
            <button class="button is-primary is-small is-fullwidth">{% trans 'Save' %}</button>
        </div>
        <div class="column is-4 has-text-centered">
            <a class="button is-info is-small is-fullwidth"
               href="{% url 'django_ledger:data-import-jobs-list' entity_slug=entity_slug %}">
                {% trans 'Import Job List' %}</a>
        </div>
    </div>

</form>

